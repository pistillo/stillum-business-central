# US-10.2.1 – Piano di implementazione: Editor di codice React con supporto TypeScript

## Obiettivo

Come sviluppatore, voglio un editor di codice React con IntelliSense e supporto TypeScript, in modo da scrivere pools, droplets e triggers con produttività.

## Contesto

- Monaco Editor è già presente nel progetto (`@monaco-editor/react` v4.7.0)
- Backend già pronto da US-10.1.1: campo `source_code`, `npm_dependencies`, API CRUD MODULE/COMPONENT
- EditorPage supporta XML/JSON/YAML, estensione a TypeScript/TSX

## Componenti da creare/modificare

### Nuovi componenti

1. **`ReactEditorPage`** (nuovo)
   - Pagina dedicata per editing MODULE/COMPONENT
   - Monaco Editor configurato per TypeScript/TSX
   - Load/save da campo `source_code`
   - Integrazione con `DependenciesPanel`

2. **`DependenciesPanel`** (nuovo)
   - Pannello laterale per gestione dipendenze npm
   - Ricerca pacchetti npm (autocomplete)
   - Aggiunta/rimozione dipendenze
   - Visualizzazione lista dipendenze correnti

3. **`ModuleCreationWizard`** (nuovo)
   - Wizard guidato per creare nuovo MODULE/COMPONENT
   - Step 1: Selezione tipo (MODULE/COMPONENT)
   - Step 2: Metadata (title, description, area, tags)
   - Step 3: Per COMPONENT, selezione MODULE padre
   - Step 4: Conferma e creazione

### Componenti da modificare

1. **`EditorPage.tsx`**
   - Aggiungere formato `typescript` per MODULE/COMPONENT
   - Configurare Monaco con linguaggio `typescript`/`tsx`
   - Supportare load/save da `source_code` invece di `payloadRef`

2. **`NewArtifactPage.tsx`**
   - Aggiungere opzioni MODULE e COMPONENT al wizard esistente
   - Per COMPONENT: mostrare campo `parentModuleId`

3. **`CataloguePage.tsx`**
   - Aggiungere filtri per MODULE e COMPONENT
   - Vista aggregata per mostrare MODULE con i relativi COMPONENT

4. **`api/registry.ts`**
   - Aggiungere funzioni per gestire `source_code` e `npm_dependencies`
   - Estendere `createVersion` e `updateVersion` per supportare i nuovi campi

## Piano di implementazione

### Fase 1: API Client (Backend integration)

**Prerequisite:** US-10.1.1 completata ✅

| Task | Output | Note |
|------|--------|------|
| Aggiungere `updateSourceCode()` | Funzione in `api/registry.ts` | PUT su `/artifacts/{id}/versions/{vid}/source-code` |
| Aggiungere `getSourceCode()` | Funzione in `api/registry.ts` | GET su `/artifacts/{id}/versions/{vid}/source-code` |
| Aggiungere `updateNpmDependencies()` | Funzione in `api/registry.ts` | PUT su `/artifacts/{id}/versions/{vid}/npm-dependencies` |
| Aggiungere `createModule()` | Funzione in `api/registry.ts` | POST su `/artifacts/modules` |
| Aggiungere `createComponent()` | Funzione in `api/registry.ts` | POST su `/artifacts/components` |

### Fase 2: Estensione EditorPage per TypeScript

| Task | Output | Note |
|------|--------|------|
| Aggiungere formato `typescript` | `EditorPage.tsx` | Estendere `getFormats()` per MODULE/COMPONENT |
| Configurare Monaco per TypeScript | `EditorPage.tsx` | Linguaggio `typescript`/`tsx` |
| Load da `source_code` | `EditorPage.tsx` | Sostituire payloadRef con source_code |
| Save su `source_code` | `EditorPage.tsx` | Chiamare nuova API updateSourceCode() |

### Fase 3: DependenciesPanel

| Task | Output | Note |
|------|--------|------|
| Creare componente `DependenciesPanel` | `components/DependenciesPanel.tsx` | Pannello laterale |
| Implementare lista dipendenze | `DependenciesPanel.tsx` | Render lista da `npm_dependencies` |
| Implementare ricerca npm | `DependenciesPanel.tsx` | Autocomplete da registry npm |
| Implementare aggiunta dipendenza | `DependenciesPanel.tsx` | Aggiorna `npm_dependencies` |
| Implementare rimozione dipendenza | `DependenciesPanel.tsx` | Rimuove da `npm_dependencies` |
| Integrare con ReactEditorPage | `ReactEditorPage.tsx` | Sidebar con DependenciesPanel |

### Fase 4: ModuleCreationWizard

| Task | Output | Note |
|------|--------|------|
| Creare componente `ModuleCreationWizard` | `components/ModuleCreationWizard.tsx` | Wizard multi-step |
| Step 1: Selezione tipo | `ModuleCreationWizard.tsx` | MODULE o COMPONENT |
| Step 2: Metadata | `ModuleCreationWizard.tsx` | title, description, area, tags |
| Step 3: Parent MODULE | `ModuleCreationWizard.tsx` | Solo per COMPONENT |
| Step 4: Conferma | `ModuleCreationWizard.tsx` | Riepilogo e creazione |
| Integrare con NewArtifactPage | `NewArtifactPage.tsx` | Opzione MODULE/COMPONENT |

### Fase 5: Aggiornamento CataloguePage

| Task | Output | Note |
|------|--------|------|
| Aggiungere filtri MODULE/COMPONENT | `CataloguePage.tsx` | Filtri tipo artefatto |
| Vista aggregata MODULE | `CataloguePage.tsx` | Card con lista COMPONENT |

## Dettaglio tecnico

### Monaco Editor TypeScript

```typescript
import Editor from '@monaco-editor/react';

<Editor
  height="600px"
  language="typescript"
  theme="vs-dark"
  value={sourceCode}
  onChange={setSourceCode}
  options={{
    minimap: { enabled: false },
    fontSize: 14,
    lineNumbers: 'on',
    scrollBeyondLastLine: false,
    automaticLayout: true,
    tabSize: 2,
    insertSpaces: true,
  }}
/>
```

### Type definitions per React

Monaco ha bisogno delle type definitions React per IntelliSense:

```typescript
// Configurazione Monaco per React
import * as monaco from 'monaco-editor';

monaco.languages.typescript.typescriptDefaults.addExtraLib(
  `declare module 'react' {
    export * from 'react';
  }`,
  'file:///node_modules/@types/react/index.d.ts'
);
```

### Struttura dati npm_dependencies

```typescript
type NpmDependencies = Record<string, string>;

// Esempio:
{
  "react": "^18.2.0",
  "react-dom": "^18.2.0",
  "lucide-react": "^0.263.1"
}
```

## Deliverables

### File nuovi
- `portal-ui/src/pages/ReactEditorPage.tsx`
- `portal-ui/src/components/DependenciesPanel.tsx`
- `portal-ui/src/components/ModuleCreationWizard.tsx`

### File modificati
- `portal-ui/src/pages/EditorPage.tsx`
- `portal-ui/src/pages/NewArtifactPage.tsx`
- `portal-ui/src/pages/CataloguePage.tsx`
- `portal-ui/src/api/registry.ts`

## Dipendenze

### Esterne
- `@monaco-editor/react` ✅ già installato (v4.7.0)
- `@types/react` da includere per IntelliSense

### Interne
- US-10.1.1 ✅ completata (backend)

## Test

### Unit test
- `DependenciesPanel.test.tsx`: test componenti panel
- `ModuleCreationWizard.test.tsx`: test wizard steps

### Integrazione test
- Test load/save source_code
- Test gestione dipendenze npm
- Test creazione MODULE/COMPONENT

## Timeline stimata

| Fase | Giorni |
|------|--------|
| Fase 1: API Client | 1 |
| Fase 2: Estensione EditorPage | 2 |
| Fase 3: DependenciesPanel | 2 |
| Fase 4: ModuleCreationWizard | 2 |
| Fase 5: CataloguePage | 1 |
| Test e fix | 1 |
| **Totale** | **9 giorni** |

## Note importanti

1. **Separazione EditorPage vs ReactEditorPage**: Considerare se estendere EditorPage esistente o creare pagina dedicata
2. **Validazione TypeScript**: Implementare validazione in-editor con segnalazione errori
3. **Anteprima live**: Opzionale, sandbox iframe per preview React component (task T-10.2.1.5)
4. **Performance**: Monaco con TypeScript può essere pesante, considerare lazy loading
5. **Offline support**: Monaco con type definitions richiede connessione per download iniziale
